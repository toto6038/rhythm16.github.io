<!DOCTYPE html>
<html lang="en">
  <head>
    

<script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script>

<meta charset="utf-8" >

<title>KVM ARM: 新 page table walker</title>
<meta name="keywords" content="KVM ARM: 新 page table walker, blog keywords">
<meta name="description" content="
Linux版本：v6.0
處理器架構：ARMv8

前言在Linux kernel 5.10週期，KVM ARM開發者們為了為google pkvm做準備，在code base許多地方做了翻修，今天就是介紹其中新設計的page table">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="stylesheet" href="/style/main.css">


<link rel="stylesheet" href="/style/jquery.fancybox.min.css">




    <link rel="stylesheet" href="/style/prism.css"/>




  <meta name="generator" content="Hexo 6.3.0"></head>
  <body>
    <div id="app" class="main">

<div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="http://rhythm16.github.io">
        <img class="avatar" src="/images/avatar.png" alt="" width="32px" height="32px">
      </a>
      <a href="http://rhythm16.github.io">
        <h1 class="site-title"></h1>
      </a>
    </div>
    <div class="right">
        <i class="icon menu-switch icon-menu-outline" ></i>
    </div>
  </div>
</div>

<div class="menu-container" style="height: 0;opacity: 0;">
<nav class="menu-list">
  
    
      <a href="/" class="menu purple-link">
        Home
      </a>
    
  
    
      <a href="/tags" class="menu purple-link">
        Tags
      </a>
    
  
    
      <a href="/categories" class="menu purple-link">
        Categories
      </a>
    
  
    
      <a href="/archives" class="menu purple-link">
        Archives
      </a>
    
  
    
      <a href="/about" class="menu purple-link">
        About
      </a>
    
  
</nav>
</div>



  <div class="content-container">
    <div class="post-detail">
      
      <h2 class="post-title">KVM ARM: 新 page table walker</h2>
      <div class="post-info post-detail-info">
        <span><i class="icon icon-calendar-outline"></i> 2022-11-03</span>
        
          <span>
          <i class="icon icon-pricetags-outline"></i>
            
              <a href="/tags/Linux/">
              Linux
                
                  ，
                
              </a>
            
              <a href="/tags/KVM/">
              KVM
                
                  ，
                
              </a>
            
              <a href="/tags/ARMv8/">
              ARMv8
                
                  ，
                
              </a>
            
              <a href="/tags/page-tables/">
              page tables
                
              </a>
            
          </span>
        
      </div>
      <div class="post-content-wrapper">
        <div class="post-content">
          <blockquote>
<p>Linux版本：v6.0</p>
<p>處理器架構：ARMv8</p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在Linux kernel 5.10週期，KVM ARM開發者們為了為<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=wY-u6n75iXc">google pkvm</a>做準備，在code base許多地方做了翻修，今天就是介紹其中新設計的page table walker。</p>
<p>原先在KVM ARM中在做page table walk的時候，寫法就是單純的在需要的地方直接一路access然後dereference下去，e.g. <code>create_hyp_&#123;p4d, pud, pmd, pte&#125;_mappings</code> 這幾個函數。這樣做的缺點之一就是軟體在存取page tables時code很難重複使用，而新的作法在5.10中出現，把存取page table這樣的操作模組化，各個需要存取page table的地方都能共用同樣的程式。</p>
<h2 id="重要結構"><a href="#重要結構" class="headerlink" title="重要結構"></a>重要結構</h2><p>使用新的page table walker時，需要提供一些資訊：</p>
<ol>
<li><p>所要存取的page table (<code>struct kvm_pgtable</code>)</p>
</li>
<li><p>想要對page table進行的操作，以及walk到哪裡時進行 (<code>struct kvm_pgtable_walker</code>)</p>
</li>
<li><p>訪問哪個虛擬位址範圍 (<code>struct kvm_pgtable_walk_data</code>)</p>
</li>
</ol>
<p>見以下說明：</p>
<h3 id="kvm-pgtable"><a href="#kvm-pgtable" class="headerlink" title="kvm_pgtable"></a><code>kvm_pgtable</code></h3><p>紀錄一整個page table tree的metadata，以下簡單說明幾個重要的成員</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable</span> <span class="token punctuation">&#123;</span>  
        u32                                     ia_bits<span class="token punctuation">;</span> <span class="token comment">// 這個page table所翻譯的virtual address是幾個bits</span>
        u32                                     start_level<span class="token punctuation">;</span> <span class="token comment">// 從第幾層開始</span>
        <span class="token class-name">kvm_pte_t</span>                               <span class="token operator">*</span>pgd<span class="token punctuation">;</span> <span class="token comment">// 重要成員：root page table的linear map address</span>
        <span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable_mm_ops</span>               <span class="token operator">*</span>mm_ops<span class="token punctuation">;</span> <span class="token comment">// 操作此page table的相關函數e.g.申請&amp;釋放記憶體</span>
                                  
        <span class="token comment">/* Stage-2 only */</span>  
        <span class="token keyword">struct</span> <span class="token class-name">kvm_s2_mmu</span>                       <span class="token operator">*</span>mmu<span class="token punctuation">;</span> <span class="token comment">// 略</span>
        <span class="token keyword">enum</span> <span class="token class-name">kvm_pgtable_stage2_flags</span>           flags<span class="token punctuation">;</span> <span class="token comment">// 略</span>
        <span class="token class-name">kvm_pgtable_force_pte_cb_t</span>              force_pte_cb<span class="token punctuation">;</span> <span class="token comment">// 略</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="kvm-pgtable-walker"><a href="#kvm-pgtable-walker" class="headerlink" title="kvm_pgtable_walker"></a><code>kvm_pgtable_walker</code></h3><p>提供使用者設定訪問page table時呼叫的函數以及何時呼叫，<code>cb</code> 代表”call back”</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable_walker</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> <span class="token class-name">kvm_pgtable_visitor_fn_t</span>          cb<span class="token punctuation">;</span> <span class="token comment">// 在walk這個page table tree時會呼叫的函數      </span>
        <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token keyword">const</span>                            arg<span class="token punctuation">;</span> <span class="token comment">// 傳遞給cb的參數</span>
        <span class="token keyword">const</span> <span class="token keyword">enum</span> <span class="token class-name">kvm_pgtable_walk_flags</span>       flags<span class="token punctuation">;</span> <span class="token comment">// 設定什麼時候要呼叫cb，有三個不互斥的選項：</span>
<span class="token comment">// 1. KVM_PGTABLE_WALK_LEAF: 走到葉節點時呼叫</span>
<span class="token comment">// 2. KVM_PGTABLE_WALK_TABLE_PRE: 訪問子節點前呼叫</span>
<span class="token comment">// 3. KVM_PGTABLE_WALK_TABLE_POST: 訪問子節點後呼叫</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="kvm-pgtable-walk-data"><a href="#kvm-pgtable-walk-data" class="headerlink" title="kvm_pgtable_walk_data"></a><code>kvm_pgtable_walk_data</code></h3><p>想要訪問的位址區間，可以看出<code>kvm_pgtable_walk_data</code> 實際上包含了前兩者的資訊</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable_walk_data</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable</span>              <span class="token operator">*</span>pgt<span class="token punctuation">;</span> <span class="token comment">// 指向要存取的page table metadata</span>
        <span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable_walker</span>       <span class="token operator">*</span>walker<span class="token punctuation">;</span> <span class="token comment">// 指向使用的walker</span>

        u64                             addr<span class="token punctuation">;</span> <span class="token comment">// walk起始位址</span>
        u64                             end<span class="token punctuation">;</span> <span class="token comment">// walk結束位址</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="新walker實作"><a href="#新walker實作" class="headerlink" title="新walker實作"></a>新walker實作</h2><p>接著就可以來看walker的入口點<code>kvm_pgtable_walk</code>:</p>
<h3 id="kvm-pgtable-walk"><a href="#kvm-pgtable-walk" class="headerlink" title="kvm_pgtable_walk"></a><code>kvm_pgtable_walk</code></h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">kvm_pgtable_walk</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable</span> <span class="token operator">*</span>pgt<span class="token punctuation">,</span> u64 addr<span class="token punctuation">,</span> u64 size<span class="token punctuation">,</span>
                     <span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable_walker</span> <span class="token operator">*</span>walker<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable_walk_data</span> walk_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                <span class="token punctuation">.</span>pgt    <span class="token operator">=</span> pgt<span class="token punctuation">,</span>
                <span class="token punctuation">.</span>addr   <span class="token operator">=</span> <span class="token function">ALIGN_DOWN</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">.</span>end    <span class="token operator">=</span> <span class="token function">PAGE_ALIGN</span><span class="token punctuation">(</span>walk_data<span class="token punctuation">.</span>addr <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">.</span>walker <span class="token operator">=</span> walker<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">_kvm_pgtable_walk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>walk_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這個函數預期<code>pgt</code> 和<code>walker</code> caller已經準備好了，再加上利用傳進來的<code>addr</code> 和<code>size</code> 製作出這次所使用的<code>kvm_pgtalbe_walk_data</code>，然後呼叫<code>_kvm_pgtable_walk</code>。</p>
<h3 id="kvm-pgtable-walk-1"><a href="#kvm-pgtable-walk-1" class="headerlink" title="_kvm_pgtable_walk"></a><code>_kvm_pgtable_walk</code></h3><p>這個函數負責各個root page，見註解</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">_kvm_pgtable_walk</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable_walk_data</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        u32 idx<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable</span> <span class="token operator">*</span>pgt <span class="token operator">=</span> data<span class="token operator">-></span>pgt<span class="token punctuation">;</span>
        u64 limit <span class="token operator">=</span> <span class="token function">BIT</span><span class="token punctuation">(</span>pgt<span class="token operator">-></span>ia_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-></span>addr <span class="token operator">></span> limit <span class="token operator">||</span> data<span class="token operator">-></span>end <span class="token operator">></span> limit<span class="token punctuation">)</span> <span class="token comment">// 範圍檢查</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ERANGE<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pgt<span class="token operator">-></span>pgd<span class="token punctuation">)</span> <span class="token comment">// 檢查有沒有root page table</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token comment">// 在某些系統設定之下，ARMv8的stage 2 page table root page可以不只一頁，</span>
        <span class="token comment">// 而是連續多頁(&lt; 16頁)</span>
        <span class="token comment">// 這個for loop就是loop過這n個root page, idx: 0 ~ n-1</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>idx <span class="token operator">=</span> <span class="token function">kvm_pgd_page_idx</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> data<span class="token operator">-></span>addr <span class="token operator">&lt;</span> data<span class="token operator">-></span>end<span class="token punctuation">;</span> <span class="token operator">++</span>idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 每個循環ptep指向當前root page</span>
                <span class="token class-name">kvm_pte_t</span> <span class="token operator">*</span>ptep <span class="token operator">=</span> <span class="token operator">&amp;</span>pgt<span class="token operator">-></span>pgd<span class="token punctuation">[</span>idx <span class="token operator">*</span> PTRS_PER_PTE<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">// 呼叫更底層的實作函數</span>
                ret <span class="token operator">=</span> <span class="token function">__kvm_pgtable_walk</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> ptep<span class="token punctuation">,</span> pgt<span class="token operator">-></span>start_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
 
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="kvm-pgtable-walk-2"><a href="#kvm-pgtable-walk-2" class="headerlink" title="__kvm_pgtable_walk"></a><code>__kvm_pgtable_walk</code></h3><p>這個函數loop過一個page的entries</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__kvm_pgtable_walk</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable_walk_data</span> <span class="token operator">*</span>data<span class="token punctuation">,</span>
                <span class="token operator">></span>             <span class="token class-name">kvm_pte_t</span> <span class="token operator">*</span>pgtable<span class="token punctuation">,</span> u32 level<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        u32 idx<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果當前的page table level超過最大值(4)就錯誤退出</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span>level <span class="token operator">>=</span> KVM_PGTABLE_MAX_LEVELS<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token comment">// 利用kvm_pgtable_idx計算開始訪問的index</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>idx <span class="token operator">=</span> <span class="token function">kvm_pgtable_idx</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span> idx <span class="token operator">&lt;</span> PTRS_PER_PTE<span class="token punctuation">;</span> <span class="token operator">++</span>idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 計算當前看的entry的位址</span>
                <span class="token class-name">kvm_pte_t</span> <span class="token operator">*</span>ptep <span class="token operator">=</span> <span class="token operator">&amp;</span>pgtable<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果走完範圍了就退出</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-></span>addr <span class="token operator">>=</span> data<span class="token operator">-></span>end<span class="token punctuation">)</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment">// 把data和當前看的位址以及當前的level當作輸入</span>
                <span class="token comment">// 呼叫實際操作的函數</span>
                ret <span class="token operator">=</span> <span class="token function">__kvm_pgtable_visit</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> ptep<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="kvm-pgtable-visit"><a href="#kvm-pgtable-visit" class="headerlink" title="__kvm_pgtable_visit"></a><code>__kvm_pgtable_visit</code></h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">__kvm_pgtable_visit</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable_walk_data</span> <span class="token operator">*</span>data<span class="token punctuation">,</span>
                                      <span class="token class-name">kvm_pte_t</span> <span class="token operator">*</span>ptep<span class="token punctuation">,</span> u32 level<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        u64 addr <span class="token operator">=</span> data<span class="token operator">-></span>addr<span class="token punctuation">;</span>
        <span class="token comment">// pte: 當前entry的"值"</span>
        <span class="token class-name">kvm_pte_t</span> <span class="token operator">*</span>childp<span class="token punctuation">,</span> pte <span class="token operator">=</span> <span class="token operator">*</span>ptep<span class="token punctuation">;</span>
        <span class="token comment">// 這個entry指到的是不是一個table?</span>
        bool table <span class="token operator">=</span> <span class="token function">kvm_pte_table</span><span class="token punctuation">(</span>pte<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">enum</span> <span class="token class-name">kvm_pgtable_walk_flags</span> flags <span class="token operator">=</span> data<span class="token operator">-></span>walker<span class="token operator">-></span>flags<span class="token punctuation">;</span>
        <span class="token comment">// 如果entry指到table而且訪問子節點前要呼叫</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>table <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> KVM_PGTABLE_WALK_TABLE_PRE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// kvm_pgtable_visitor_cb只是一個簡單的wrapper幫忙</span>
                <span class="token comment">// 用傳入的參數呼叫walker->cb</span>
                ret <span class="token operator">=</span> <span class="token function">kvm_pgtable_visitor_cb</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> level<span class="token punctuation">,</span> ptep<span class="token punctuation">,</span>
                                             KVM_PGTABLE_WALK_TABLE_PRE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 如果entry指到physical page(而不是下一層page table)</span>
        <span class="token comment">// 而且訪問葉節點要呼叫cb</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>table <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> KVM_PGTABLE_WALK_LEAF<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 呼叫cb</span>
                ret <span class="token operator">=</span> <span class="token function">kvm_pgtable_visitor_cb</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> level<span class="token punctuation">,</span> ptep<span class="token punctuation">,</span>
                                             KVM_PGTABLE_WALK_LEAF<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 由於ptep這個位址的內容有可能在呼叫cb時改變，例如cb allocate了下一層</span>
                <span class="token comment">// page table讓這個entry指到它，所以這邊更新pte的值</span>
                pte <span class="token operator">=</span> <span class="token operator">*</span>ptep<span class="token punctuation">;</span>
                <span class="token comment">// 也更新這個pte現在是不是指到table</span>
                table <span class="token operator">=</span> <span class="token function">kvm_pte_table</span><span class="token punctuation">(</span>pte<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token comment">// 如果不是table(是葉節點)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>table<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 使data->addr對齊現在這個page table level translation的大小</span>
                data<span class="token operator">-></span>addr <span class="token operator">=</span> <span class="token function">ALIGN_DOWN</span><span class="token punctuation">(</span>data<span class="token operator">-></span>addr<span class="token punctuation">,</span> <span class="token function">kvm_granule_size</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 並使data->addr跨過現在這個level translation大小</span>
                data<span class="token operator">-></span>addr <span class="token operator">+=</span> <span class="token function">kvm_granule_size</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 處理完葉節點之後就可以退出</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 執行到這裡代表當前entry指到table，所以使用kvm_pte_follow獲取下一層page table的位址</span>
        <span class="token comment">// 值得注意的是entry是指向下一層table的實體位址，所以kvm_pte_follow裡面使用了</span>
        <span class="token comment">// phys_to_virt把entry轉換成軟體存取的EL1虛擬記憶體位址</span>
        childp <span class="token operator">=</span> <span class="token function">kvm_pte_follow</span><span class="token punctuation">(</span>pte<span class="token punctuation">,</span> data<span class="token operator">-></span>pgt<span class="token operator">-></span>mm_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 呼叫__kvm_pgtable_walk去走下一層page table</span>
        <span class="token comment">// 這邊的程式邏輯見下方說明</span>
        ret <span class="token operator">=</span> <span class="token function">__kvm_pgtable_walk</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> childp<span class="token punctuation">,</span> level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token comment">// 走完當前table entry而且訪問子節點之後要呼叫cb</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> KVM_PGTABLE_WALK_TABLE_POST<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                ret <span class="token operator">=</span> <span class="token function">kvm_pgtable_visitor_cb</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> level<span class="token punctuation">,</span> ptep<span class="token punctuation">,</span>
                                             KVM_PGTABLE_WALK_TABLE_POST<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

out<span class="token operator">:</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Page table其實是一個多child的樹狀結構(4K page就是512個child)，這個page table walker使用了遞迴的方式來對其進行操作，還支持pre-order, post-order的邏輯，<code>level</code>代表第幾層，<code>__kvm_pgtable_visit</code>負責：</p>
<ol>
<li>在適當的條件對table進行操作(呼叫callbacks)</li>
<li>推進<code>data-&gt;addr</code>的進度</li>
<li>遇到<code>table</code>的時候遞迴呼叫<code>__kvm_pgtable_walk</code></li>
</ol>
<p>而<code>__kvm_pgtable_walk</code>負責一個page table裡面的entry的loop。</p>
<h2 id="使用範例：create-hyp-mappings"><a href="#使用範例：create-hyp-mappings" class="headerlink" title="使用範例：create_hyp_mappings"></a>使用範例：<code>create_hyp_mappings</code></h2><p>Linux在初始化KVM的時候的執行模式是EL1，此時需要在進入EL2之前為其製作和設定好EL2所使用的page tables，使用的函數就是<code>create_hyp_mappings</code>。</p>
<p><code>create_hyp_mappings</code>在KVM初始化重點函數之一<code>init_hyp_mode</code> 中被多次呼叫，分別替EL2 建立了以下幾個區域的mappings：</p>
<ul>
<li>EL2 code (<code>__hyp_text_start</code> ~ <code>__hyp_text_end</code>)</li>
<li>EL2 read only data (<code>__hyp_rodata_start</code> ~ <code>__hyp_rodata_end</code>)</li>
<li>EL1 read only data (<code>__start_rodata</code> ~ <code>__end_rodata</code>)</li>
<li>EL2 BSS (<code>__hyp_bss_start</code> ~ <code>__hyp_bss_end</code>)</li>
<li>EL1 BSS (<code>__hyp_bss_end</code> ~ <code>__bss_stop</code>)</li>
<li>EL2 stack</li>
<li>EL2 percpu area</li>
</ul>
<blockquote>
<p>這個函數只是建立page tables，並不會進到EL2啟動EL2的address translation機制</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * create_hyp_mappings - duplicate a kernel virtual address range in Hyp mode
 * @from:       The virtual kernel start address of the range
 * @to:         The virtual kernel end address of the range (exclusive)
 * @prot:       The protection to be applied to this range
 *
 * The same virtual address as the kernel virtual address is also used
 * in Hyp-mode mapping (modulo HYP_PAGE_OFFSET) to the same underlying
 * physical pages.
 */</span>
<span class="token keyword">int</span> <span class="token function">create_hyp_mappings</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>to<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">kvm_pgtable_prot</span> prot<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token class-name">phys_addr_t</span> phys_addr<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> virt_addr<span class="token punctuation">;</span>
        <span class="token comment">// 使用kern_hyp_va把輸入的EL1虛擬位址始末轉換成EL2虛擬位址</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token function">kern_hyp_va</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token function">kern_hyp_va</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判斷處理器是否處於EL2 (VHE模式)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_kernel_in_hyp_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// pkvm相關，略</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">kvm_host_owns_hyp_mappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
        <span class="token comment">// 將起始與結束位址對齊頁邊界</span>
        start <span class="token operator">=</span> start <span class="token operator">&amp;</span> PAGE_MASK<span class="token punctuation">;</span>
        end <span class="token operator">=</span> <span class="token function">PAGE_ALIGN</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 迴圈loop過輸入範圍，每一次迴圈會利用`kvm_kaddr_to_phys`計算對應的物理位址，呼叫`__create_hyp_mappings` ，並前進一個`PAGE_SIZE`</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>virt_addr <span class="token operator">=</span> start<span class="token punctuation">;</span> virt_addr <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> virt_addr <span class="token operator">+=</span> PAGE_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> err<span class="token punctuation">;</span>

                phys_addr <span class="token operator">=</span> <span class="token function">kvm_kaddr_to_phys</span><span class="token punctuation">(</span>from <span class="token operator">+</span> virt_addr <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
                err <span class="token operator">=</span> <span class="token function">__create_hyp_mappings</span><span class="token punctuation">(</span>virt_addr<span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">,</span> phys_addr<span class="token punctuation">,</span>
                                            prot<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>註解其實就對這個函數有不少說明，作為輸入的<code>from</code>, <code>to</code> 是想要map給EL2的EL1虛擬位址區間，<code>prot</code> 則是讀寫執行等權限設定。有趣的是並不需要指定要map給EL2的虛擬位址，EL2的虛擬位址規劃KVM自身有機制決定，具體來說就是利用<code>kern_hyp_va</code> 把EL1的虛擬位址轉換成EL2的虛擬位址。</p>
<h3 id="create-hyp-mappings"><a href="#create-hyp-mappings" class="headerlink" title="__create_hyp_mappings"></a><code>__create_hyp_mappings</code></h3><p>鎖上<code>kvm_hyp_pgd_mutex</code> 然後呼叫<code>kvm_pgtable_hyp_map</code>，注意<code>hyp_pgtable</code>即為page table walk所需的<code>kvm_pgtable</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">__create_hyp_mappings</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> start<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">,</span>
                          <span class="token keyword">unsigned</span> <span class="token keyword">long</span> phys<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">kvm_pgtable_prot</span> prot<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> err<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">kvm_host_owns_hyp_mappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
 
        <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kvm_hyp_pgd_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        err <span class="token operator">=</span> <span class="token function">kvm_pgtable_hyp_map</span><span class="token punctuation">(</span>hyp_pgtable<span class="token punctuation">,</span> start<span class="token punctuation">,</span> size<span class="token punctuation">,</span> phys<span class="token punctuation">,</span> prot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kvm_hyp_pgd_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="kvm-pgtable-hyp-map"><a href="#kvm-pgtable-hyp-map" class="headerlink" title="kvm_pgtable_hyp_map"></a><code>kvm_pgtable_hyp_map</code></h3><p>這個函數就會呼叫新的page table walker <code>kvm_pgtable_walk</code>了，呼叫之前製作所需的<code>kvm_pgtable_walker</code>(1)，和傳入的<code>hyp_pgtable</code>(參數<code>pgt</code>)一起傳給<code>kvm_pgtable_walk</code>(2)</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">kvm_pgtable_hyp_map</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable</span> <span class="token operator">*</span>pgt<span class="token punctuation">,</span> u64 addr<span class="token punctuation">,</span> u64 size<span class="token punctuation">,</span> u64 phys<span class="token punctuation">,</span>
                        <span class="token keyword">enum</span> <span class="token class-name">kvm_pgtable_prot</span> prot<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">hyp_map_data</span> map_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                <span class="token punctuation">.</span>phys   <span class="token operator">=</span> <span class="token function">ALIGN_DOWN</span><span class="token punctuation">(</span>phys<span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">.</span>mm_ops <span class="token operator">=</span> pgt<span class="token operator">-></span>mm_ops<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">kvm_pgtable_walker</span> walker <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token comment">// (1)</span>
                <span class="token punctuation">.</span>cb     <span class="token operator">=</span> hyp_map_walker<span class="token punctuation">,</span>
                <span class="token punctuation">.</span>flags  <span class="token operator">=</span> KVM_PGTABLE_WALK_LEAF<span class="token punctuation">,</span>
                <span class="token punctuation">.</span>arg    <span class="token operator">=</span> <span class="token operator">&amp;</span>map_data<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">hyp_set_prot_attr</span><span class="token punctuation">(</span>prot<span class="token punctuation">,</span> <span class="token operator">&amp;</span>map_data<span class="token punctuation">.</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">kvm_pgtable_walk</span><span class="token punctuation">(</span>pgt<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>walker<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// (2)</span>
        <span class="token function">dsb</span><span class="token punctuation">(</span>ishst<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">isb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可想而知，作為<code>cb</code> ，只在碰到葉節點(<code>flags: KVM_PGTABLE_WALK_LEAF</code>)會被呼叫的<code>hyp_map_walker</code> 就會負責申請各級的page tables並安裝進適當的page table entries。</p>

        </div>
        <div class="top-div">
          <ol class="top-box"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E5%89%8D%E8%A8%80"><span class="top-box-text">前言</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E9%87%8D%E8%A6%81%E7%B5%90%E6%A7%8B"><span class="top-box-text">重要結構</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#kvm-pgtable"><span class="top-box-text">kvm_pgtable</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#kvm-pgtable-walker"><span class="top-box-text">kvm_pgtable_walker</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#kvm-pgtable-walk-data"><span class="top-box-text">kvm_pgtable_walk_data</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E6%96%B0walker%E5%AF%A6%E4%BD%9C"><span class="top-box-text">新walker實作</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#kvm-pgtable-walk"><span class="top-box-text">kvm_pgtable_walk</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#kvm-pgtable-walk-1"><span class="top-box-text">_kvm_pgtable_walk</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#kvm-pgtable-walk-2"><span class="top-box-text">__kvm_pgtable_walk</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#kvm-pgtable-visit"><span class="top-box-text">__kvm_pgtable_visit</span></a></li></ol></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#%E4%BD%BF%E7%94%A8%E7%AF%84%E4%BE%8B%EF%BC%9Acreate-hyp-mappings"><span class="top-box-text">使用範例：create_hyp_mappings</span></a><ol class="top-box-child"><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#create-hyp-mappings"><span class="top-box-text">__create_hyp_mappings</span></a></li><li class="top-box-item top-box-level-3"><a class="top-box-link" href="#kvm-pgtable-hyp-map"><span class="top-box-text">kvm_pgtable_hyp_map</span></a></li></ol></li></ol>
        </div>
      </div>
    </div>

    
      <div class="next-post">
        <a class="purple-link" href="/2022/01/27/linux_symbols/">
          <h3 class="post-title">
            Next: Looking for Kernel Symbol Addresses in the Linux Kernel Image
          </h3>
        </a>
      </div>
    
  </div>




<footer>
<div class="site-footer">
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
  
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a>
  
  
  
  
  
  
</div>
</footer>


      </div>
      
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.fancybox.min.js"></script>



    <script>window.is_post = true;</script>


<script src="/js/main.js"></script>





    </div>
  </body>
</html>

